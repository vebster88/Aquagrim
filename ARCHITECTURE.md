# Архитектура проекта

## Общая структура

Проект следует принципам разделения ответственности (Separation of Concerns):

```
┌─────────────────────────────────────────┐
│         Telegram Bot API                 │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│           bot.ts                        │
│  - Инициализация бота                   │
│  - Обработка команд                     │
│  - Маршрутизация сообщений              │
└──────────────┬──────────────────────────┘
               │
       ┌───────┴────────┐
       │               │
       ▼               ▼
┌─────────────┐  ┌─────────────┐
│   flows/    │  │   admin/    │
│  - Утреннее │  │  - Панель    │
│  - Вечернее │  │  - Управление│
│  - Редакт.  │  │              │
└──────┬──────┘  └──────┬───────┘
       │               │
       └───────┬───────┘
               │
               ▼
┌─────────────────────────────────────────┐
│         services/                       │
│  - CalculationService (расчеты)         │
│  - PDFService (генерация PDF)           │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│            db/                           │
│  - Обертки над Vercel KV                │
│  - CRUD операции                        │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│         Vercel KV                       │
│  (Redis-совместимое хранилище)          │
└─────────────────────────────────────────┘
```

## Потоки данных

### Утреннее заполнение

```
User → bot.ts → MorningFillFlow → db/kv.ts → Vercel KV
                                      ↓
                              createLog() → Vercel KV
```

### Вечерний отчет

```
User → bot.ts → EveningReportFlow → CalculationService
                                      ↓
                              db/kv.ts → Vercel KV
```

### Редактирование

```
User → bot.ts → EditFlow → db/kv.ts → Vercel KV
                            ↓
                      createLog() → Vercel KV
```

### Генерация PDF

```
Admin → bot.ts → AdminPanel → PDFService → Buffer
                                      ↓
                              Telegram API
```

## Состояния диалога

Состояния хранятся в `Session` в Vercel KV:

```typescript
Session {
  state: DialogState,  // Текущее состояние
  context: {            // Контекст заполнения
    flow: 'morning' | 'evening' | 'edit',
    site: {...},
    report: {...},
    editContext: {...}
  }
}
```

### Машина состояний

```
idle
  ↓
morning_fill_site_name
  ↓
morning_fill_bonus_target
  ↓
morning_fill_phone
  ↓
[Создание Site] → idle

idle
  ↓
evening_fill_lastname
  ↓
evening_fill_firstname
  ↓
...
  ↓
evening_fill_responsible_signature
  ↓
[Расчет + Создание Report] → idle
```

## Модель данных в KV

### Ключи

- `user:{id}` — пользователь
- `user:tg:{telegram_id}` — индекс для поиска по Telegram ID
- `session:{user_id}` — сессия пользователя
- `site:{id}` — площадка
- `site:date:{date}` — множество ID площадок за дату
- `report:{id}` — отчет
- `report:site:{site_id}:{date}` — множество ID отчетов по площадке
- `report:lastname:{lastname}` — множество ID отчетов по фамилии
- `log:{id}` — лог действия
- `logs:user:{user_id}` — список ID логов пользователя
- `counter:{prefix}` — счетчик для генерации ID

### Индексы

Для быстрого поиска используются Redis Sets:
- `site:date:{date}` — все площадки за дату
- `report:site:{site_id}:{date}` — все отчеты по площадке
- `report:lastname:{lastname}` — все отчеты по фамилии

## Обработка ошибок

1. **Валидация входных данных** — на уровне flows
2. **Обработка ошибок KV** — try/catch в db/kv.ts
3. **Глобальный обработчик** — bot.catch() в bot.ts
4. **Логирование** — все ошибки логируются

## Производительность

- **Кэширование сессий** — сессии хранятся в KV для быстрого доступа
- **Индексы** — использование Redis Sets для быстрого поиска
- **Асинхронность** — все операции асинхронные
- **Батчинг** — группировка операций где возможно

## Безопасность

1. **Аутентификация** — по Telegram ID
2. **Авторизация** — роли (user, admin, superadmin)
3. **Валидация** — все входные данные валидируются
4. **Логирование** — все действия логируются
5. **HTTPS** — вебхук работает только по HTTPS (Vercel)

## Масштабируемость

- **Горизонтальное масштабирование** — Vercel Functions автоматически масштабируются
- **Хранилище** — Vercel KV поддерживает высокие нагрузки
- **Статус-код** — до 30 площадок одновременно (как указано в ТЗ)

## Расширяемость

Архитектура позволяет легко добавлять:
- Новые потоки диалогов (добавить в `flows/`)
- Новые сервисы (добавить в `services/`)
- Новые типы действий (расширить `LogActionType`)
- Новые роли (расширить `UserRole`)

